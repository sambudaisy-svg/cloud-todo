<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>âœ¨ Magic To-Do</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            background: #f0f2f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-top: 40px;
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        .input-area {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }
        #taskInput {
            flex: 1;
            padding: 12px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #addBtn {
            padding: 12px 20px;
            background: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        #addBtn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        #taskList {
            list-style: none;
            padding: 0;
        }
        .task-item {
            background: #f8f9fa;
            padding: 15px;
            margin: 10px 0;
            border-radius: 5px;
            border-left: 4px solid #4285f4;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 3px;
            cursor: pointer;
        }
        .status {
            padding: 10px;
            margin: 10px 0 20px 0;
            border-radius: 5px;
            text-align: center;
            font-size: 14px;
        }
        .loading { background: #fff3cd; color: #856404; }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>âœ¨ Magic To-Do</h1>
        
        <div id="status" class="status loading">
            ðŸ”„ Connecting to database...
        </div>
        
        <div class="input-area">
            <input 
                type="text" 
                id="taskInput" 
                placeholder="Enter a task..." 
                maxlength="60"
            >
            <button id="addBtn" disabled>Add</button>
        </div>
        
        <ul id="taskList">
            <!-- Tasks will appear here -->
        </ul>
    </div>

    <script type="module">
        // ============================================
        // Firebase (v9 modular) via CDN
        // ============================================
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { 
            getFirestore,
            collection,
            addDoc,
            deleteDoc,
            doc,
            onSnapshot,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        // ============================================
        // Your Firebase Configuration
        // (From Firebase console â†’ Project settings â†’ Web app)
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyBaKTubE1V2JAaymVPzf-VegKFbuKhb13Q",
            authDomain: "class-todo-app-ecf33.firebaseapp.com",
            projectId: "class-todo-app-ecf33",
            storageBucket: "class-todo-app-ecf33.appspot.com",
            messagingSenderId: "908171908566",
            appId: "1:908171908566:web:74fb4b5196f01b1a6ac077"
        };

        // ============================================
        // DOM Elements
        // ============================================
        const statusEl = document.getElementById('status');
        const taskInput = document.getElementById('taskInput');
        const addBtn = document.getElementById('addBtn');
        const taskList = document.getElementById('taskList');

        // ============================================
        // Helper: Update status banner
        // ============================================
        function updateStatus(message, type) {
            statusEl.textContent = message;
            statusEl.className = `status ${type}`;
        }

        // ============================================
        // Initialize Firebase and Firestore
        // ============================================
        async function initApp() {
            try {
                updateStatus("Initializing Firebase...", "loading");

                const app = initializeApp(firebaseConfig);
                const db = getFirestore(app);

                console.log("âœ… Firebase initialized");
                updateStatus("Firebase initialized. Connecting to tasks...", "loading");

                setupApp(db);
            } catch (error) {
                console.error("Firebase error:", error);
                updateStatus(`Firebase Error: ${error.message}`, "error");
            }
        }

        // ============================================
        // Main App Logic
        // ============================================
        function setupApp(db) {
            const tasksCol = collection(db, 'tasks');

            // Enable the Add button now that DB is ready
            addBtn.disabled = false;

            // -------------------------
            // Add Task
            // -------------------------
            async function addTask() {
                const text = taskInput.value.trim();
                if (!text) return;

                addBtn.disabled = true;
                addBtn.textContent = "Adding...";

                try {
                    await addDoc(tasksCol, {
                        text: text,
                        created: serverTimestamp(),
                        timestamp: Date.now()  // used for local sorting
                    });

                    taskInput.value = "";
                    taskInput.focus();
                } catch (error) {
                    console.error("Add error:", error);
                    alert("Error adding task: " + error.message);
                } finally {
                    addBtn.disabled = false;
                    addBtn.textContent = "Add";
                }
            }

            // Button & Enter key
            addBtn.onclick = addTask;
            taskInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') addTask();
            });

            // -------------------------
            // Real-time Listener
            // -------------------------
            onSnapshot(
                tasksCol,
                (snapshot) => {
                    if (snapshot.empty) {
                        taskList.innerHTML = '<li style="text-align:center; color:#666; padding:20px;">No tasks yet. Add one above!</li>';
                        updateStatus("Ready! Add your first task.", "success");
                        return;
                    }

                    taskList.innerHTML = "";
                    const tasks = [];

                    snapshot.forEach((docSnap) => {
                        tasks.push({
                            id: docSnap.id,
                            ...docSnap.data()
                        });
                    });

                    // Sort newest first using our timestamp field
                    tasks.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));

                    tasks.forEach((task) => {
                        const li = document.createElement('li');
                        li.className = 'task-item';

                        const textSpan = document.createElement('span');
                        textSpan.textContent = task.text || "(no text)";
                        li.appendChild(textSpan);

                        const deleteBtn = document.createElement('button');
                        deleteBtn.className = 'delete-btn';
                        deleteBtn.textContent = 'Delete';
                        deleteBtn.addEventListener('click', async () => {
                            if (confirm("Delete this task?")) {
                                try {
                                    await deleteDoc(doc(db, "tasks", task.id));
                                } catch (error) {
                                    console.error("Delete error:", error);
                                    alert("Error deleting task: " + error.message);
                                }
                            }
                        });

                        li.appendChild(deleteBtn);
                        taskList.appendChild(li);
                    });

                    updateStatus(`Loaded ${tasks.length} task(s)`, "success");
                },
                (error) => {
                    console.error("Firestore error:", error);
                    updateStatus(`Connection error: ${error.message}`, "error");
                }
            );

            updateStatus("âœ… Connected! Ready to add tasks.", "success");
        }

        // Start the app
        initApp();
    </script>
</body>
</html>
